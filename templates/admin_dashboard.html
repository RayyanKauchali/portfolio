{% extends "base.html" %}
{% block title %}Admin Dashboard{% endblock %}

{% block head_css %}
    <link rel="stylesheet" href="{{ url_for('static', filename='css/admin.css') }}">
{% endblock %}

{% block content %}
<div class="page active" id="admin-dashboard">
    <section class="page-section">
        <div class="container">
            <div class="admin-header">
                <h2 class="text-cyan">Admin Dashboard</h2>
            </div>

            <!-- Flash messages for success/errors -->
            {% with messages = get_flashed_messages(with_categories=true) %}
                {% if messages %}
                    {% for category, message in messages %}
                        <div class="flash-message {{ category }}">{{ message }}</div>
                    {% endfor %}
                {% endif %}
            {% endwith %}

            {% if db_is_empty %}
            <div class="flash-message info">
                <strong>Your database is empty!</strong><br>
                To seed the initial project and skill data, please visit this secret URL one time:
                <a href="{{ url_for('first_time_setup') }}" style="color:white; font-weight:bold; text-decoration: underline;">Run First-Time Setup</a>
            </div>
            {% endif %}

            <!-- Tab Navigation -->
            <div class="admin-tabs">
                <!-- --- NEW ROADMAP TAB --- -->
                <button class="tab-button active" data-tab="roadmap">Roadmap</button>
                <button class="tab-button" data-tab="projects">Projects</button>
                <button class="tab-button" data-tab="skills">Skills</button>
                <button class="tab-button" data-tab="certificates">Certificates</button>
            </div>

            <!-- --- NEW TAB CONTENT: ROADMAP --- -->
            <div id="roadmap" class="tab-content active">
                <!-- Active Task -->
                <div class="admin-card" style="border-color: var(--accent-cyan);">
                    <h3><i class="fas fa-rocket text-cyan"></i> Active Task</h3>
                    <div class="admin-list">
                        {% for task in todos_active %}
                            <div class="admin-list-item active-task">
                                <div class="admin-list-item-content">
                                    <strong>{{ task.task }}</strong>
                                    <p class="text-secondary" style="margin:0;">Category: {{ task.category }}</p>
                                </div>
                                <div class="admin-list-item-actions">
                                    <form action="{{ url_for('set_complete_task', id=task.id) }}" method="POST" style="flex-grow: 1;">
                                        <button type="submit" class="admin-btn-complete">Complete & Next</button>
                                    </form>
                                    <form action="{{ url_for('set_pause_task', id=task.id) }}" method="POST">
                                        <button type="submit" class="admin-btn-pause">Pause</button>
                                    </form>
                                </div>
                            </div>
                        {% else %}
                            <p class="text-secondary">No active task. Go to "Pending" and start one!</p>
                        {% endfor %}
                    </div>
                </div>

                <div class="admin-section">
                    <!-- Add New Task Form -->
                    <div class="admin-card">
                        <h3>Add New Task</h3>
                        <form action="{{ url_for('add_todo') }}" method="POST" class="admin-form-col">
                            <div class="form-group">
                                <label for="task-task">Task</label>
                                <textarea id="task-task" name="task" rows="3" placeholder="e.g., Learn how to use Docker Swarm" required></textarea>
                            </div>
                            <div class="form-group">
                                <label for="task-category">Category</label>
                                <input type="text" id="task-category" name="category" placeholder="e.g., Learning, Project, Portfolio" required>
                            </div>
                            <button type="submit" class="admin-btn">Add to Pending</button>
                        </form>
                    </div>
                    <!-- Paused Tasks List -->
                    <div class="admin-card">
                        <h3><i class="fas fa-pause-circle text-secondary"></i> Paused Tasks</h3>
                        <div class="admin-list">
                            {% for task in todos_paused %}
                            <div class="admin-list-item">
                                <div class="admin-list-item-content">
                                    <strong>{{ task.task }}</strong>
                                </div>
                                <div class="admin-list-item-actions">
                                    <form action="{{ url_for('set_active_task', id=task.id) }}" method="POST">
                                        <button type="submit" class="admin-btn-start">Start</button>
                                    </form>
                                    <a href="{{ url_for('edit_todo', id=task.id) }}" class="admin-btn-edit">Edit</a>
                                </div>
                            </div>
                            {% else %}
                            <p class="text-secondary">No tasks are paused.</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>

                <div class="admin-section">
                    <!-- Pending Tasks List -->
                    <div class="admin-card">
                        <h3><i class="fas fa-list-ol text-secondary"></i> Pending Queue</h3>
                        <div class="admin-list">
                            {% for task in todos_pending %}
                            <div class="admin-list-item">
                                <div class="admin-list-item-content">
                                    <strong>{{ task.task }}</strong>
                                    <p class="text-secondary" style="margin:0;">Category: {{ task.category }}</p>
                                </div>
                                <div class="admin-list-item-actions">
                                    <form action="{{ url_for('set_active_task', id=task.id) }}" method="POST">
                                        <button type="submit" class="admin-btn-start">Start</button>
                                    </form>
                                    <a href="{{ url_for('edit_todo', id=task.id) }}" class="admin-btn-edit">Edit</a>
                                    <form action="{{ url_for('delete_todo', id=task.id) }}" method="POST" onsubmit="return confirm('Are you sure?');">
                                        <button type="submit" class="admin-btn-delete">Del</button>
                                    </form>
                                </div>
                            </div>
                            {% else %}
                            <p class="text-secondary">No pending tasks!</p>
                            {% endfor %}
                        </div>
                    </div>
                    <!-- Completed Tasks List -->
                    <div class="admin-card">
                        <h3><i class="fas fa-check-circle text-secondary"></i> Recently Completed</h3>
                         <div class="admin-list">
                            {% for task in todos_done %}
                            <div class="admin-list-item" style="opacity: 0.6;">
                                <div class="admin-list-item-content">
                                    <strong style="text-decoration: line-through;">{{ task.task }}</strong>
                                    <p class="text-secondary" style="margin:0;">Completed: {{ task.completed_at.strftime('%Y-%m-%d') }}</p>
                                </div>
                            </div>
                            {% else %}
                            <p class="text-secondary">No tasks completed yet.</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Projects -->
            <div id="projects" class="tab-content">
                <!-- ... (existing code, no changes) ... -->
                <div class="admin-section">
                    <div class="admin-card">
                        <h3>Add New Project</h3>
                        <form action="{{ url_for('add_project') }}" method="POST" class="admin-form-col">
                            <div class="form-group">
                                <label for="proj-title">Title</label>
                                <input type="text" id="proj-title" name="title" required>
                            </div>
                            <div class="form-group">
                                <label for="proj-role">Role</label>
                                <input type="text" id="proj-role" name="role" required>
                            </div>
                            <div class="form-group">
                                <label for="proj-tech">Tech Stack (comma-separated)</label>
                                <input type="text" id="proj-tech" name="tech" required>
                            </div>
                            <div class="form-group">
                                <label for="proj-image">Image URL</label>
                                <input type="text" id="proj-image" name="image">
                            </div>
                            <div class="form-group">
                                <label for="proj-desc">Description</label>
                                <textarea id="proj-desc" name="description" rows="3" required></textarea>
                            </div>
                            <button type="submit" class="admin-btn">Add Project</button>
                        </form>
                    </div>
                    <div class="admin-card">
                        <h3>Manage Projects</h3>
                        <div class="admin-list">
                            {% for project in projects %}
                            <div class="admin-list-item">
                                <div class="admin-list-item-content">
                                    <strong>{{ project.title }}</strong>
                                    <p class="text-secondary" style="margin:0;">{{ project.role }}</p>
                                </div>
                                <div class="admin-list-item-actions">
                                    <a href="{{ url_for('edit_project', id=project.id) }}" class="admin-btn-edit">Edit</a>
                                    <form action="{{ url_for('delete_project', id=project.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this project?');">
                                        <button type="submit" class="admin-btn-delete">Delete</button>
                                    </form>
                                </div>
                            </div>
                            {% else %}
                            <p class="text-secondary">No projects found.</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Skills -->
            <div id="skills" class="tab-content">
                <!-- ... (existing code, no changes) ... -->
                <div class="admin-section">
                    <div class="admin-card">
                        <h3>Add New Skill</h3>
                        <form action="{{ url_for('add_skill') }}" method="POST" class="admin-form-col">
                            <div class="form-group">
                                <label for="skill-category">Category</label>
                                <input type="text" id="skill-category" name="category" placeholder="e.g., Data Science & AI/ML" required>
                            </div>
                            <div class="form-group">
                                <label for="skill-name">Skill Name</label>
                                <input type="text" id="skill-name" name="name" placeholder="e.g., PyTorch" required>
                            </div>
                            <div class="form-group">
                                <label for="skill-svg">SVG Code</label>
                                <textarea id="skill-svg" name="svg" rows="5" placeholder="<svg>...</svg>"></textarea>
                            </div>
                            <button type="submit" class="admin-btn">Add Skill</button>
                        </form>
                    </div>
                    <div class="admin-card">
                        <h3>Manage Skills</h3>
                        <div class="admin-list">
                            {% for skill in skills %}
                            <div class="admin-list-item">
                                <div class="admin-list-item-content">
                                    <strong>{{ skill.name }}</strong>
                                    <p class="text-secondary" style="margin:0;">{{ skill.category }}</p>
                                </div>
                                <div class="admin-list-item-actions">
                                    <a href="{{ url_for('edit_skill', id=skill.id) }}" class="admin-btn-edit">Edit</a>
                                    <form action="{{ url_for('delete_skill', id=skill.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this skill?');">
                                        <button type="submit" class="admin-btn-delete">Delete</button>
                                    </form>
                                </div>
                            </div>
                            {% else %}
                            <p class="text-secondary">No skills found.</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Tab Content: Certificates -->
            <div id="certificates" class="tab-content">
                <!-- ... (existing code, no changes) ... -->
                <div class="admin-section">
                    <div class="admin-card">
                        <h3>Add New Certificate</h3>
                        <form action="{{ url_for('add_certificate') }}" method="POST" class="admin-form-col">
                            <div class="form-group">
                                <label for="cert-title">Title</label>
                                <input type="text" id="cert-title" name="title" required>
                            </div>
                            <div class="form-group">
                                <label for="cert-provider">Provider</label>
                                <input type="text" id="cert-provider" name="provider" required>
                            </div>
                            <div class="form-group">
                                <label for="cert-icon">FontAwesome Icon</label>
                                <input type="text" id="cert-icon" name="icon" placeholder="e.g., fa-brands fa-google">
                            </div>
                            <button type="submit" class="admin-btn" style="margin-top: 1.5rem;">Add Certificate</button>
                        </form>
                    </div>
                    <div class="admin-card">
                        <h3>Manage Certificates</h3>
                        <div class="admin-list">
                            {% for cert in certificates %}
                            <div class="admin-list-item">
                                <div class="admin-list-item-content">
                                    <i class="{{ cert.icon }}"></i>
                                    <strong>{{ cert.title }}</strong>
                                </div>
                                <div class="admin-list-item-actions">
                                    <a href="{{ url_for('edit_certificate', id=cert.id) }}" class="admin-btn-edit">Edit</a>
                                    <form action="{{ url_for('delete_certificate', id=cert.id) }}" method="POST" onsubmit="return confirm('Are you sure you want to delete this certificate?');">
                                        <button type="submit" class="admin-btn-delete">Delete</button>
                                    </form>
                                </div>
                            </div>
                            {% else %}
                            <p class="text-secondary">No certificates found.</p>
                            {% endfor %}
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </section>
</div>

<!-- Simple JS for Tabs -->
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');

        // Function to show a tab
        function showTab(tabId) {
            tabButtons.forEach(btn => btn.classList.remove('active'));
            tabContents.forEach(content => content.classList.remove('active'));

            const button = document.querySelector(`[data-tab="${tabId}"]`);
            const content = document.getElementById(tabId);
            
            if (button) button.classList.add('active');
            if (content) content.classList.add('active');
        }

        // Add click listeners
        tabButtons.forEach(button => {
            button.addEventListener('click', () => {
                const tabId = button.dataset.tab;
                if(history.pushState) {
                    history.pushState(null, null, '#' + tabId);
                } else {
                    location.hash = '#' + tabId;
                }
                showTab(tabId);
            });
        });

        // Check for hash in URL on page load
        const initialTab = window.location.hash.substring(1);
        if (initialTab && document.getElementById(initialTab)) {
            showTab(initialTab);
        } else {
            // Show the first tab (Roadmap) by default
            showTab('roadmap');
        }
    });
</script>
{% endblock %}